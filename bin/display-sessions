#!/bin/bash

GREEN=$(tput setaf 2)
GREY=$(tput setaf 7)
RESET=$(tput sgr0)

# Define icons with colors
SESSION_ICON="\033[32m\033[0m"    # Green icon for active tmux sessions
TMUXP_ICON="\033[37m\033[0m"     # Grey icon for tmuxp sessions

# Get the current tmux session
CURRENT_SESSION=$(tmux display-message -p '#S')

# List active tmux sessions and prepend the icon, excluding the current session
SESSIONS=$(tmux list-sessions -F "#{session_name}" | grep -v "^$CURRENT_SESSION$" | sed "s/^/$SESSION_ICON /")

# List tmuxp sessions from the .config/tmuxp directory, excluding active ones and the current session
# and only including those with valid start_directory paths
TMUXP_DIR="$HOME/.config/tmuxp"
if [ -d "$TMUXP_DIR" ]; then
  TMUXP_SESSIONS=""
  for file in "$TMUXP_DIR"/*.yaml; do
    session_name=$(yq e '.session_name' "$file")  # Extract session_name using yq
    start_directory=$(yq e '.start_directory' "$file")  # Extract start_directory using yq

    # Expand tilde (~) to the full home directory path
    start_directory=$(eval echo "$start_directory")

    # Check if the session is not active (including the current session) and if the start_directory exists
    if [ -d "$start_directory" ] && ! echo "$SESSIONS" | grep -q "$session_name" && [ "$session_name" != "$CURRENT_SESSION" ]; then
      TMUXP_SESSIONS+="$TMUXP_ICON $session_name"$'\n'
    fi
  done
fi

# Combine the session lists
COMBINED_SESSIONS=$(echo -e "Sessions:\n$SESSIONS\n$TMUXP_SESSIONS")

# Display the sessions in a tmux popup and allow the user to select one
SELECTED_SESSION=$(echo -e "$COMBINED_SESSIONS" | fzf --layout=reverse --border)

# Exit if no session is selected (Escape or empty selection)
if [ -z "$SELECTED_SESSION" ]; then
  exit 0
fi

# Strip the icon from the selected session before handling it
STRIPPED_SESSION="${SELECTED_SESSION#* }"

# Switch to the selected tmux session if it exists, or load the tmuxp session in detached state
if echo "$SESSIONS" | grep -q "$SELECTED_SESSION$"; then
  tmux switch-client -t "$STRIPPED_SESSION"
elif echo "$TMUXP_SESSIONS" | grep -q "$SELECTED_SESSION$"; then
  # Load the tmuxp session in detached mode
  tmuxp load -d "$STRIPPED_SESSION"
  # Immediately switch to the newly loaded session
  tmux switch-client -t "$STRIPPED_SESSION"
fi

